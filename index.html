<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>臨床研究 研修記録管理</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans JP', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
      background-color: #F8FAFC;
      min-height: 100vh;
    }
    
    /* ヘッダー */
    .header {
      background: linear-gradient(135deg, #0F766E 0%, #115E59 100%);
      color: white;
      padding: 20px 32px;
      box-shadow: 0 4px 20px rgba(15, 118, 110, 0.3);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 22px;
      font-weight: 700;
    }
    
    .header p {
      font-size: 13px;
      opacity: 0.85;
      margin-top: 4px;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .date-display {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-outline {
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .btn-outline:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* メインコンテンツ */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px;
    }
    
    /* テーブル */
    .table-wrapper {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th {
      padding: 14px 16px;
      text-align: left;
      background: #F1F5F9;
      font-weight: 600;
      color: #334155;
      border-bottom: 2px solid #E2E8F0;
      white-space: nowrap;
      position: sticky;
      top: 0;
    }
    
    th.th-training {
      min-width: 280px;
    }
    
    th.th-member {
      min-width: 110px;
      text-align: center;
    }
    
    .member-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .member-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .member-role {
      font-size: 11px;
      color: #64748B;
      font-weight: 400;
    }
    
    tr:nth-child(even) {
      background: #F8FAFC;
    }
    
    tr:hover {
      background: #F0FDFA;
    }
    
    td {
      padding: 12px 16px;
      border-bottom: 1px solid #E2E8F0;
    }
    
    td.td-training {
      font-weight: 500;
    }
    
    td.td-record {
      text-align: center;
      padding: 8px;
    }
    
    .training-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .training-name {
      flex: 1;
    }
    
    .training-hours {
      font-size: 12px;
      font-weight: 500;
      color: #0F766E;
      background: #CCFBF1;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    
    .training-meta {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
    }
    
    .training-category {
      color: #6366F1;
      background: #EEF2FF;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .training-provider {
      color: #64748B;
      background: #F1F5F9;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .required-badge {
      font-size: 10px;
      font-weight: 600;
      color: #DC2626;
      background: #FEE2E2;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    /* 完了ボタン */
    .record-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 52px;
      padding: 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .record-btn:hover {
      transform: scale(1.05);
    }
    
    .record-btn.completed {
      background: #D1FAE5;
      color: #059669;
    }
    
    .record-btn.not-completed {
      background: #F1F5F9;
      color: #94A3B8;
    }
    
    .record-btn.not-completed:hover {
      background: #E0F2FE;
      color: #0284C7;
    }
    
    .check-mark {
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }
    
    .empty-mark {
      font-size: 22px;
      color: #CBD5E1;
    }
    
    .completed-date {
      font-size: 10px;
      margin-top: 2px;
    }
    
    /* 凡例 */
    .legend {
      margin-top: 24px;
      padding: 16px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .legend h3 {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 12px;
    }
    
    .legend-items {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #64748B;
    }
    
    .legend-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-weight: 700;
      font-size: 18px;
    }
    
    .legend-icon.completed {
      background: #D1FAE5;
      color: #059669;
    }
    
    .legend-icon.not-completed {
      background: #F1F5F9;
      color: #CBD5E1;
    }
    
    /* 統計 */
    .stats {
      margin-top: 24px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stats h3 {
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 16px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    
    .stat-card {
      padding: 12px;
      background: #F8FAFC;
      border-radius: 8px;
    }
    
    .stat-name {
      font-size: 13px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }
    
    .stat-progress {
      height: 6px;
      background: #E2E8F0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stat-bar {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    
    .stat-text {
      font-size: 12px;
      color: #64748B;
      margin-top: 6px;
    }
    
    /* フッター */
    .footer {
      text-align: center;
      padding: 20px;
      color: #94A3B8;
      font-size: 12px;
    }
    
    /* 印刷用 */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .header {
        background: #0F766E !important;
        -webkit-print-color-adjust: exact;
      }
      
      .table-wrapper {
        box-shadow: none;
        border: 1px solid #E2E8F0;
      }
    }
    
    /* レスポンシブ */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      
      .main {
        padding: 16px;
      }
      
      th.th-training {
        min-width: 200px;
      }
      
      th.th-member {
        min-width: 90px;
      }
    }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <header class="header">
    <div class="header-content">
      <div>
        <h1>臨床研究 研修記録</h1>
        <p>北里大学病院 臨床研究推進センター</p>
      </div>
      <div class="header-right">
        <span class="date-display" id="currentDate"></span>
        <button class="btn btn-outline no-print" onclick="showPrintModal()">研修記録ダウンロード</button>
        <button class="btn btn-outline no-print" onclick="exportData()">データ出力</button>
        <button class="btn btn-outline no-print" onclick="showAdminLogin()">データ読込</button>
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileUpload(event)">
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="main">
    <div class="table-wrapper">
      <table id="trainingTable">
        <thead>
          <tr id="headerRow">
            <th class="th-training">研修項目</th>
            <!-- メンバーのヘッダーはJSで生成 -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- 内容はJSで生成 -->
        </tbody>
      </table>
    </div>

    <!-- 凡例 -->
    <div class="legend no-print">
      <h3>使い方</h3>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-icon completed">○</span>
          <span>完了済み（クリックで取消）</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon not-completed">−</span>
          <span>未完了（クリックで完了登録）</span>
        </div>
      </div>
    </div>

    <!-- 統計 -->
    <div class="stats">
      <h3>完了状況サマリー</h3>
      <div class="stats-grid" id="statsGrid">
        <!-- 内容はJSで生成 -->
      </div>
    </div>
  </main>

  <!-- フッター -->
  <footer class="footer">
    <p>© 2024 北里大学病院 臨床研究推進センター</p>
  </footer>

  <!-- 管理者ログインモーダル -->
  <div id="adminModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:32px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); max-width:400px; width:90%;">
      <h3 style="margin:0 0 20px 0; font-size:18px; color:#334155;">管理者認証</h3>
      <p style="margin:0 0 16px 0; font-size:14px; color:#64748B;">データ読込を行うにはパスワードを入力してください。</p>
      <input type="password" id="adminPassword" placeholder="パスワード" style="width:100%; padding:12px; border:1px solid #E2E8F0; border-radius:8px; font-size:14px; margin-bottom:16px; box-sizing:border-box;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="closeAdminModal()" style="padding:10px 20px; border:1px solid #E2E8F0; background:white; border-radius:8px; font-size:14px; cursor:pointer;">キャンセル</button>
        <button onclick="verifyAndSelectFile()" style="padding:10px 20px; border:none; background:#0F766E; color:white; border-radius:8px; font-size:14px; cursor:pointer;">ファイル選択</button>
      </div>
      <p id="errorMsg" style="color:#DC2626; font-size:13px; margin-top:12px; display:none;">パスワードが正しくありません。</p>
    </div>
  </div>

  <!-- 印刷モーダル -->
  <div id="printModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:32px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); max-width:500px; width:90%;">
      <!-- 選択画面 -->
      <div id="printSelectView">
        <h3 style="margin:0 0 20px 0; font-size:18px; color:#334155;">研修記録のダウンロード</h3>
        <p style="margin:0 0 16px 0; font-size:14px; color:#64748B;">担当者を選択してWord形式で研修記録をダウンロードします。</p>
        <div id="memberSelectList" style="max-height:300px; overflow-y:auto; border:1px solid #E2E8F0; border-radius:8px; margin-bottom:16px;">
          <!-- メンバーリストはJSで生成 -->
        </div>
        <div style="display:flex; gap:12px; justify-content:flex-end;">
          <button onclick="closePrintModal()" style="padding:10px 20px; border:1px solid #E2E8F0; background:white; border-radius:8px; font-size:14px; cursor:pointer;">キャンセル</button>
          <button onclick="generateWordDocument()" style="padding:10px 20px; border:none; background:#0F766E; color:white; border-radius:8px; font-size:14px; cursor:pointer;">ダウンロード</button>
        </div>
      </div>
      <!-- ローディング画面 -->
      <div id="printLoadingView" style="display:none; text-align:center; padding:40px 20px;">
        <div style="width:50px; height:50px; border:4px solid #E2E8F0; border-top:4px solid #0F766E; border-radius:50%; margin:0 auto 20px; animation:spin 1s linear infinite;"></div>
        <p style="font-size:16px; color:#334155; margin:0;">只今、ダウンロード中です...</p>
      </div>
    </div>
  </div>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ============================================================
    // 【設定エリア】研修項目とメンバーをここで編集してください
    // ============================================================
    
    // 管理者パスワード
    const ADMIN_PASSWORD = 'kazu123';
    
    // 研修項目マスタ（必要に応じて追加・編集）
    let TRAINING_ITEMS = [
      { id: 1, name: '観察型疫学研究と検証型臨床試験の違い', category: '必須', provider: 'ICRweb', min: 24 },
      { id: 2, name: '臨床試験に必要な統計的考え方', category: '実務', provider: 'ICRweb', min: 30 },
      { id: 3, name: '臨床試験におけるデータの質の保証', category: '実務', provider: 'ICRweb', min: 34 },
      { id: 4, name: '臨床試験を行う際に知っておかなければならない研究倫理', category: '実務', provider: 'ICRweb', min: 34 },
      { id: 5, name: '疫学分野における臨床試験の実例', category: '実務', provider: 'ICRweb', hours: 24 },
      { id: 6, name: '臨床研究の歴史、意義、研究の定式化（2012年度版）', category: '実務', provider: 'ICRweb', min: 70 },
      { id: 7, name: '臨床研究のデザインと統計学（2012年度版）', category: '実務', provider: 'ICRweb', min: 51 },
      { id: 8, name: '患者立脚型アウトカムの測定：主観的尺度の開発と検証', category: '実務', provider: 'ICRweb', min: 78 },
    ];
    // メンバーマスタ（必要に応じて追加・編集）
    let MEMBERS = [
      { id: 1, name: '中川 智枝', role: 'PM' },
      { id: 2, name: '見戸 幸子', role: 'PM' },
      { id: 3, name: '小林 祐太', role: 'PM' },
      { id: 4, name: '大石 理絵', role: 'PM' },
      { id: 5, name: '稲葉 咲子', role: 'DM' },
      { id: 6, name: '香川 理沙', role: 'DM' },
      { id: 7, name: '高橋 和彦', role: 'OT' },
    ];
    
    // ============================================================
    // 以下はシステムコード（通常は編集不要）
    // ============================================================
    
    // ローカルストレージのキー
    const STORAGE_KEY = 'trainingRecords';
    const STORAGE_KEY_TRAINING = 'trainingItems';
    const STORAGE_KEY_MEMBERS = 'memberItems';
    
    // 研修記録データ
    let records = {};
    
    // 初期化
    function init() {
      // 日付表示
      document.getElementById('currentDate').textContent = formatDateJP(new Date());
      
      // 保存データの読み込み（研修項目・メンバー・記録）
      loadMasterData();
      loadRecords();
      
      // テーブル生成
      renderTable();
      
      // 統計更新
      updateStats();
    }
    
    // マスタデータ（研修項目・メンバー）をローカルストレージから読み込み
    function loadMasterData() {
      // 研修項目の読み込み
      const savedTraining = localStorage.getItem(STORAGE_KEY_TRAINING);
      if (savedTraining) {
        try {
          const parsed = JSON.parse(savedTraining);
          if (Array.isArray(parsed) && parsed.length > 0) {
            TRAINING_ITEMS = parsed;
          }
        } catch (e) {
          console.error('研修項目の読み込みエラー:', e);
        }
      }
      
      // メンバーの読み込み
      const savedMembers = localStorage.getItem(STORAGE_KEY_MEMBERS);
      if (savedMembers) {
        try {
          const parsed = JSON.parse(savedMembers);
          if (Array.isArray(parsed) && parsed.length > 0) {
            MEMBERS = parsed;
          }
        } catch (e) {
          console.error('メンバーの読み込みエラー:', e);
        }
      }
    }
    
    // マスタデータ（研修項目・メンバー）をローカルストレージに保存
    function saveMasterData() {
      localStorage.setItem(STORAGE_KEY_TRAINING, JSON.stringify(TRAINING_ITEMS));
      localStorage.setItem(STORAGE_KEY_MEMBERS, JSON.stringify(MEMBERS));
    }
    
    // ローカルストレージから読み込み
    function loadRecords() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          records = JSON.parse(saved);
        } catch (e) {
          records = {};
        }
      }
    }
    
    // ローカルストレージに保存
    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }
    
    // テーブル生成
    function renderTable() {
      const headerRow = document.getElementById('headerRow');
      const tableBody = document.getElementById('tableBody');
      
      // ヘッダー（メンバー列）を追加
      MEMBERS.forEach(member => {
        const th = document.createElement('th');
        th.className = 'th-member';
        th.innerHTML = `
          <div class="member-header">
            <span class="member-name">${member.name}</span>
            <span class="member-role">${member.role}</span>
          </div>
        `;
        headerRow.appendChild(th);
      });
      
      // 本体（研修行）を生成
      TRAINING_ITEMS.forEach(training => {
        const tr = document.createElement('tr');
        
        // 研修名セル
        const tdTraining = document.createElement('td');
        tdTraining.className = 'td-training';
        tdTraining.innerHTML = `
          <div class="training-info">
            ${training.category === '必須' ? '<span class="required-badge">必須</span>' : ''}
            <span class="training-name">${training.name}</span>
            <span class="training-hours">${training.hours || training.min || 0}min</span>
          </div>
          <div class="training-meta">
            <span class="training-category">${training.category || ''}</span>
            <span class="training-provider">${training.provider || ''}</span>
          </div>
        `;
        tr.appendChild(tdTraining);
        
        // メンバーごとの記録セル
        MEMBERS.forEach(member => {
          const td = document.createElement('td');
          td.className = 'td-record';
          
          const key = `${member.id}-${training.id}`;
          const record = records[key];
          
          const btn = document.createElement('button');
          btn.className = `record-btn ${record ? 'completed' : 'not-completed'}`;
          btn.title = record 
            ? `完了: ${record}\nクリックで取消` 
            : 'クリックで完了登録';
          btn.onclick = () => toggleRecord(member.id, training.id);
          
          if (record) {
            btn.innerHTML = `
              <span class="check-mark">○</span>
              <span class="completed-date">${record}</span>
            `;
          } else {
            btn.innerHTML = `<span class="empty-mark">−</span>`;
          }
          
          td.appendChild(btn);
          tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
      });
    }
    
    // 記録のトグル
    function toggleRecord(memberId, trainingId) {
      const key = `${memberId}-${trainingId}`;
      
      if (records[key]) {
        // 完了を取り消し
        if (confirm('この研修記録を取り消しますか？')) {
          delete records[key];
        } else {
          return;
        }
      } else {
        // 完了を記録
        records[key] = formatDate(new Date());
      }
      
      // 保存
      saveRecords();
      
      // 画面更新（シンプルに再描画）
      document.getElementById('headerRow').innerHTML = '<th class="th-training">研修項目</th>';
      document.getElementById('tableBody').innerHTML = '';
      renderTable();
      updateStats();
    }
    
    // 統計更新
    function updateStats() {
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = '';
      
      MEMBERS.forEach(member => {
        const completed = TRAINING_ITEMS.filter(t => records[`${member.id}-${t.id}`]).length;
        const total = TRAINING_ITEMS.length;
        const percentage = Math.round((completed / total) * 100);
        
        let barColor = '#F59E0B'; // 黄色
        if (percentage === 100) barColor = '#059669'; // 緑
        else if (percentage >= 50) barColor = '#0D9488'; // ティール
        
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-name">${member.name}</div>
          <div class="stat-progress">
            <div class="stat-bar" style="width: ${percentage}%; background-color: ${barColor};"></div>
          </div>
          <div class="stat-text">${completed}/${total}件 (${percentage}%)</div>
        `;
        statsGrid.appendChild(card);
      });
    }
    
    // 日付フォーマット（YYYY/MM/DD）
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}/${m}/${d}`;
    }
    
    // 日付フォーマット（日本語）
    function formatDateJP(date) {
      return date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    
    // データ出力（CSV形式）
    function exportData() {
      let csv = '研修項目,';
      csv += MEMBERS.map(m => m.name).join(',') + '\n';
      
      TRAINING_ITEMS.forEach(training => {
        csv += `"${training.name}",`;
        csv += MEMBERS.map(member => {
          const key = `${member.id}-${training.id}`;
          return records[key] || '';
        }).join(',');
        csv += '\n';
      });
      
      // BOM付きUTF-8でダウンロード
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `研修記録_${formatDate(new Date()).replace(/\//g, '')}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
    }
    
    // ページ読み込み時に初期化
    document.addEventListener('DOMContentLoaded', init);
    
    // ============================================================
    // 管理者機能：データ読み込み
    // ============================================================
    
    // 管理者モーダルを表示
    function showAdminLogin() {
      document.getElementById('adminModal').style.display = 'flex';
      document.getElementById('adminPassword').value = '';
      document.getElementById('errorMsg').style.display = 'none';
      document.getElementById('adminPassword').focus();
    }
    
    // 管理者モーダルを閉じる
    function closeAdminModal() {
      document.getElementById('adminModal').style.display = 'none';
    }
    
    // パスワード検証してファイル選択
    function verifyAndSelectFile() {
      const password = document.getElementById('adminPassword').value;
      
      if (password === ADMIN_PASSWORD) {
        closeAdminModal();
        document.getElementById('fileInput').click();
      } else {
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      }
    }
    
    // Enterキーでも認証できるように
    document.addEventListener('keydown', function(e) {
      if (document.getElementById('adminModal').style.display === 'flex' && e.key === 'Enter') {
        verifyAndSelectFile();
      }
      if (document.getElementById('adminModal').style.display === 'flex' && e.key === 'Escape') {
        closeAdminModal();
      }
      if (document.getElementById('printModal').style.display === 'flex' && e.key === 'Escape') {
        closePrintModal();
      }
    });
    
    // Excelファイル読み込み処理
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // 研修項目シートを読み込み
          if (workbook.SheetNames.includes('研修項目')) {
            const trainingSheet = workbook.Sheets['研修項目'];
            const trainingData = XLSX.utils.sheet_to_json(trainingSheet);
            
            TRAINING_ITEMS = trainingData.map(row => ({
              id: row['ID'],
              name: row['研修名'],
              category: row['カテゴリ'],
              provider: row['提供機関'],
              hours: row['時間(m)'] || 0
            }));
          }
          
          // メンバーシートを読み込み
          if (workbook.SheetNames.includes('メンバー')) {
            const memberSheet = workbook.Sheets['メンバー'];
            const memberData = XLSX.utils.sheet_to_json(memberSheet);
            
            MEMBERS = memberData.map(row => ({
              id: row['ID'],
              name: row['氏名'],
              role: row['役割']
            }));
          }
          
          // テーブルを再描画
          document.getElementById('headerRow').innerHTML = '<th class="th-training">研修項目</th>';
          document.getElementById('tableBody').innerHTML = '';
          renderTable();
          updateStats();
          
          // マスタデータをローカルストレージに保存
          saveMasterData();
          
          alert('データを読み込み、保存しました。\n研修項目: ' + TRAINING_ITEMS.length + '件\nメンバー: ' + MEMBERS.length + '名\n\n次回起動時もこのデータが使用されます。');
          
        } catch (error) {
          alert('ファイルの読み込みに失敗しました。\n' + error.message);
        }
      };
      
      reader.readAsArrayBuffer(file);
      event.target.value = ''; // リセット
    }
    
    // ============================================================
    // 印刷機能：Word出力
    // ============================================================
    
    // 印刷モーダルを表示
    function showPrintModal() {
      const modal = document.getElementById('printModal');
      const memberList = document.getElementById('memberSelectList');
      
      // メンバーリストを生成
      memberList.innerHTML = MEMBERS.map(member => {
        const completedCount = TRAINING_ITEMS.filter(t => records[`${member.id}-${t.id}`]).length;
        return `
          <label style="display:flex; align-items:center; padding:12px 16px; border-bottom:1px solid #E2E8F0; cursor:pointer; transition:background 0.2s;" 
                 onmouseover="this.style.background='#F0FDFA'" onmouseout="this.style.background='white'">
            <input type="radio" name="selectedMember" value="${member.id}" style="margin-right:12px; width:18px; height:18px;">
            <div style="flex:1;">
              <div style="font-weight:500; color:#334155;">${member.name}</div>
              <div style="font-size:12px; color:#64748B;">${member.role} ・ 完了: ${completedCount}/${TRAINING_ITEMS.length}件</div>
            </div>
          </label>
        `;
      }).join('');
      
      modal.style.display = 'flex';
    }
    
    // 印刷モーダルを閉じる
    function closePrintModal() {
      document.getElementById('printModal').style.display = 'none';
      // 次回表示時のために選択画面に戻す
      document.getElementById('printLoadingView').style.display = 'none';
      document.getElementById('printSelectView').style.display = 'block';
    }
    
    // Word文書を生成
    async function generateWordDocument() {
      const selectedRadio = document.querySelector('input[name="selectedMember"]:checked');
      
      if (!selectedRadio) {
        alert('担当者を選択してください。');
        return;
      }
      
      const memberId = parseInt(selectedRadio.value);
      const member = MEMBERS.find(m => m.id === memberId);
      
      if (!member) {
        alert('担当者が見つかりません。');
        return;
      }
      
      // 完了した研修を取得
      const completedTrainings = TRAINING_ITEMS.filter(t => records[`${memberId}-${t.id}`]);
      
      if (completedTrainings.length === 0) {
        alert(`${member.name}さんの完了した研修がありません。`);
        return;
      }
      
      // ローディング表示に切り替え
      document.getElementById('printSelectView').style.display = 'none';
      document.getElementById('printLoadingView').style.display = 'block';
      
      // 少し待ってから処理を開始（UIの更新を反映させるため）
      await new Promise(resolve => setTimeout(resolve, 100));
      
      try {
        // 合計時間を計算
        const totalMinutes = completedTrainings.reduce((sum, t) => sum + (t.hours || t.min || 0), 0);
        const totalHours = Math.floor(totalMinutes / 60);
        const remainMinutes = totalMinutes % 60;
        
        // 出力日
        const outputDate = formatDateJP(new Date());
        
        // 研修一覧のHTML行を生成
        const trainingRows = completedTrainings.map((training, index) => {
          const bgColor = index % 2 === 0 ? '#FFFFFF' : '#F8FAFC';
          return `
            <tr>
              <td style="border: 1px solid #CCCCCC; padding: 8px; background-color: ${bgColor};">${training.name}</td>
              <td style="border: 1px solid #CCCCCC; padding: 8px; text-align: center; background-color: ${bgColor};">${training.provider || '-'}</td>
              <td style="border: 1px solid #CCCCCC; padding: 8px; text-align: right; background-color: ${bgColor};">${training.hours || training.min || 0}</td>
            </tr>
          `;
        }).join('');
        
        // Word用のHTMLを生成
        const htmlContent = `
          <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                xmlns:w="urn:schemas-microsoft-com:office:word" 
                xmlns="http://www.w3.org/TR/REC-html40">
          <head>
            <meta charset="UTF-8">
            <title>研修記録</title>
            <style>
              @page { 
                size: A4; 
                margin: 2cm; 
              }
              body { 
                font-family: "Yu Gothic", "游ゴシック", sans-serif; 
                font-size: 12pt;
                line-height: 1.6;
              }
              h1 { 
                text-align: center; 
                font-size: 24pt; 
                margin-bottom: 30px;
                color: #333333;
              }
              .info { 
                margin-bottom: 10px; 
                font-size: 12pt;
              }
              .info-label { 
                font-weight: bold; 
              }
              .summary {
                margin: 20px 0;
                font-size: 13pt;
                font-weight: bold;
              }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 20px;
              }
              th { 
                background-color: #0F766E; 
                color: white; 
                padding: 10px 8px; 
                border: 1px solid #CCCCCC;
                font-weight: bold;
              }
              td { 
                padding: 8px; 
                border: 1px solid #CCCCCC; 
              }
              .total-row td {
                background-color: #E0F2FE;
                font-weight: bold;
              }
              .footer {
                margin-top: 40px;
                text-align: right;
                color: #64748B;
                font-size: 10pt;
              }
            </style>
          </head>
          <body>
            <h1>研修記録</h1>
            
            <p class="info"><span class="info-label">担当者名:</span> ${member.name}</p>
            <p class="info"><span class="info-label">役割:</span> ${member.role}</p>
            <p class="info"><span class="info-label">出力日:</span> ${outputDate}</p>
            
            <p class="summary">完了研修数: ${completedTrainings.length}件</p>
            
            <table>
              <thead>
                <tr>
                  <th style="width: 55%;">研修名</th>
                  <th style="width: 25%;">提供機関</th>
                  <th style="width: 20%;">時間(m)</th>
                </tr>
              </thead>
              <tbody>
                ${trainingRows}
                <tr class="total-row">
                  <td style="border: 1px solid #CCCCCC; padding: 8px; text-align: right;" colspan="2">合計時間</td>
                  <td style="border: 1px solid #CCCCCC; padding: 8px; text-align: right;">${totalMinutes}分 (${totalHours}時間${remainMinutes}分)</td>
                </tr>
              </tbody>
            </table>
            
            <p class="footer">北里大学病院 臨床研究推進センター</p>
          </body>
          </html>
        `;
        
        // Blobを作成してダウンロード
        const blob = new Blob(['\ufeff' + htmlContent], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `研修記録_${member.name}_${formatDate(new Date()).replace(/\//g, '')}.doc`;
        a.click();
        
        URL.revokeObjectURL(url);
        
        // ダウンロード完了後、モーダルを閉じる
        closePrintModal();
        
      } catch (error) {
        console.error('Word生成エラー:', error);
        // エラー時は選択画面に戻す
        document.getElementById('printLoadingView').style.display = 'none';
        document.getElementById('printSelectView').style.display = 'block';
        alert('Word文書の生成に失敗しました。\n' + error.message);
      }
    }
  </script>

</body>
</html>
